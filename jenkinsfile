pipeline {
 agent any

 stages {
  stage('Clone Code') {
   steps {
    git 'https://github.com/iamonkarlad/Student-Registration-flask-app-using-Jenkins.git'
   }
  }

    stage('Deploy to App Server') {
    steps {
        sshagent(credentials: ['student-key']) {
            sh '''
            ssh -o StrictHostKeyChecking=no ubuntu@172.31.23.172 << 'EOF'
                set -e

                if [ ! -d Student-Registration-flask-app-using-Jenkins ]; then
                    git clone https://github.com/iamonkarlad/Student-Registration-flask-app-using-Jenkins.git
                fi

                cd Student-Registration-flask-app-using-Jenkins

                # Create venv if not exists
                if [ ! -d venv ]; then
                    python3 -m venv venv
                fi

                source venv/bin/activate
                pip install --upgrade pip
                pip install -r requirements.txt

                pkill -f app.py || true
                nohup venv/bin/python app.py > app.log 2>&1 &
            EOF
            '''
        }
    }
}
    }
    }   